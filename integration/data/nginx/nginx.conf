error_log logs/nginx_error.log;
pid       logs/nginx.pid;

events {
}

http {
    proxy_send_timeout 120;
    proxy_read_timeout 300;
    proxy_buffering    off;
    keepalive_timeout  5 5;
    tcp_nodelay        on;

    server {
        resolver 127.0.0.11 valid=30s;

        listen 8080;
        server_name ~^(www\.)?(?<service>[0-9a-zA-Z\-\_]+)\.integration\.(\w+\.*)+$;

        location / {
            auth_basic "Integration access. Identify yourself first!";
            auth_basic_user_file /etc/nginx/conf.d/nginx.htpasswd;

            set $service_name $service;
            proxy_pass http://$service_name:8080;
        }
    }

    server {
        listen 8080;

        location / {
            auth_basic           "Who are you?";
            auth_basic_user_file /etc/nginx/conf.d/nginx.htpasswd;

            root /etc/nginx/htdocs;
        }
    }
}